#!/bin/bash

. vars

function light {
    theme=$LIGHTTHEME
    feh --bg-scale $LIGHTBG
    conky_col1=7
    conky_col2=7
}

function dark {
    theme=$DARKTHEME
    feh --bg-scale $DARKBG
    conky_col1=2
    conky_col2=2
}

if [ $# -ge 1 ]; then
    if [[ "$1" == "silent" ]]; then
        silent=1
        theme="no"
    else
        theme=$1
        if [ $# -eq 2 ]; then
            silent=$2
        fi
    fi
else
    theme="no"
fi

hour=`date +%H | sed 's/0*//'`
if [ $theme = "light" ]; then
    light
elif [ $theme = "dark" ]; then
    dark
else
    if (( $hour > 6 && $hour < 18 )); then
        light
    else
        dark
    fi
fi

if [[ ! -f $theme || (${#theme} -eq 0) ]]; then
    echo "Theme not found"
    exit -1
fi

if [[ ! -v $silent && $silent -ne 1 ]]; then
    echo "Current theme: $theme"
fi

createtheme.sh $theme > ~/.dynamic-colors/colorschemes/current-theme.sh
dynamic-colors switch current-theme

if [ -f /dev/shm/current-theme ]; then
    rm /dev/shm/current-theme
fi

ln -s $theme /dev/shm/current-theme

. load_colors.sh
sed -i -- "s/^default_color.*/default_color ${foreground:3:6}/g" ~/.conky/conkyrc_lunatico
sed -i -- "s/^color4.*/color4 ${colors[$conky_col1]:3:6}/g" ~/.conky/conkyrc_lunatico
sed -i -- "s/^default_color.*/default_color ${foreground:3:6}/g" ~/.conky/conkyrc_tasks
sed -i -- "s/^color4.*/color4 ${colors[$conky_col1]:3:6}/g" ~/.conky/conkyrc_tasks
sed -i -- "s/graph_bg_colour=0x.*, /graph_bg_colour=0x${colors[$conky_col2]:3:6}, /g" ~/.conky/conky_lunatico.lua
sed -i -- "s/graph_fg_colour=0x.*, /graph_fg_colour=0x${colors[$conky_col1]:3:6}, /g" ~/.conky/conky_lunatico.lua
sed -i -- "s/hand_fg_colour=0x.*, /hand_fg_colour=0x${colors[$conky_col1]:3:6}, /g" ~/.conky/conky_lunatico.lua
sed -i -- "s/txt_fg_colour=0x.*, /txt_fg_colour=0x${colors[$conky_col1]:3:6}, /g" ~/.conky/conky_lunatico.lua

xrdb merge ~/.Xdefaults
restart_panel
